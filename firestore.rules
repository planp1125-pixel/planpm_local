/**
 * Core Philosophy: This ruleset implements a Role-Based Access Control (RBAC) model.
 * A dedicated `/roles_admin` collection grants administrative privileges to users whose
 * UID corresponds to a document ID within it. Admins are granted full create, update,
 * and delete permissions across the database. All other authenticated users are
 * granted read-only access to data, allowing them to view instrument and maintenance
 * information but not modify it.
 *
 * Data Structure: Data is organized hierarchically starting with a top-level
 * `/instruments` collection. Each instrument document can contain subcollections for
 * `maintenanceSchedules`, which in turn can contain `maintenanceRecords`. This
 * structure provides clear, logical grouping. A separate top-level `/files`
 * collection stores metadata for uploads.
 *
 * Key Security Decisions:
 * - Admin-Only Writes: All write operations (create, update, delete) on primary
 *   data collections are strictly limited to users with the 'admin' role.
 * - Authenticated Reads: Any signed-in user can read instrument and maintenance
 *   data, supporting a dashboard or read-only view for general lab members.
 * - Admin Role Secrecy: The `/roles_admin` collection is not readable or listable
 *   by any client, preventing users from discovering who the administrators are.
 *   Role management must be performed server-side (e.g., via the Firebase Admin SDK).
 * - Relational Integrity: On creation of subcollection documents (like schedules
 *   and records), rules enforce that the document's internal ID reference matches
 *   the ID from the document path, ensuring data consistency.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // -------------------------------------------------------------------------
    // Helper Functions
    // -------------------------------------------------------------------------

    /**
     * Returns true if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Returns true if the user has an admin role.
     * Admin status is conferred by the existence of a document in the
     * /roles_admin collection with the user's UID as the document ID.
     */
    function isAdmin() {
      return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    // -------------------------------------------------------------------------
    // Admin Roles
    // -------------------------------------------------------------------------

    /**
     * @description Manages admin role grants. The existence of a document grants admin
     *              privileges. This collection MUST NOT be manipulated by clients.
     * @path        /roles_admin/{userId}
     * @allow       (none) - This collection should only be modified by a trusted server process.
     * @deny        A client attempting to read or write to this collection.
     * @principle   Restricts sensitive role management to the backend, preventing privilege escalation.
     */
    match /roles_admin/{userId} {
      allow read, write: if false;
    }

    // -------------------------------------------------------------------------
    // Instrument Types
    // -------------------------------------------------------------------------
    /**
     * @description Stores the list of available instrument types.
     *              Readable by any authenticated user, writable by any authenticated user
     *              to allow adding new types.
     * @path        /instrumentTypes/{instrumentTypeId}
     */
    match /instrumentTypes/{instrumentTypeId} {
      allow read, create: if isSignedIn();
    }


    // -------------------------------------------------------------------------
    // Instruments & Maintenance Data
    // -------------------------------------------------------------------------

    /**
     * @description Stores instrument details. Writable only by admins, but readable
     *              by any authenticated user.
     * @path        /instruments/{instrumentId}
     * @allow       An admin (auth.uid exists in /roles_admin) creating an instrument document.
     * @deny        A non-admin user (create) attempting to create an instrument.
     * @principle   Enforces admin-only control over core data entities.
     */
    match /instruments/{instrumentId} {
      allow read, write: if isSignedIn();

      /**
       * @description Stores maintenance schedules for an instrument. Writable only by admins.
       * @path        /instruments/{instrumentId}/maintenanceSchedules/{scheduleId}
       * @allow       An admin (create) a new schedule for instrument 'inst_123' with `instrumentId: 'inst_123'` in the data.
       * @deny        An admin (create) a schedule under 'inst_123' with `instrumentId: 'inst_456'` in the data.
       * @principle   Validates relational integrity between a subcollection document and its parent path.
       */
      match /maintenanceSchedules/{scheduleId} {
        allow get: if isSignedIn();
        allow list: if isSignedIn();
        allow create: if isAdmin() && request.resource.data.instrumentId == instrumentId;
        allow update: if isAdmin() && resource != null && request.resource.data.instrumentId == resource.data.instrumentId;
        allow delete: if isAdmin() && resource != null;

        /**
         * @description Stores completed maintenance records for a schedule. Writable only by admins.
         * @path        /instruments/{instrumentId}/maintenanceSchedules/{scheduleId}/maintenanceRecords/{recordId}
         * @allow       An admin (create) a record for schedule 'sched_abc' with `scheduleId: 'sched_abc'` in the data.
         * @deny        An admin (create) a record under 'sched_abc' with `scheduleId: 'sched_xyz'` in the data.
         * @principle   Validates relational integrity between a subcollection document and its parent path.
         */
        match /maintenanceRecords/{recordId} {
          allow get: if isSignedIn();
          allow list: if isSignedIn();
          allow create: if isAdmin() && request.resource.data.scheduleId == scheduleId;
          allow update: if isAdmin() && resource != null && request.resource.data.scheduleId == resource.data.scheduleId;
          allow delete: if isAdmin() && resource != null;
        }
      }
    }

    // -------------------------------------------------------------------------
    // File Metadata
    // -------------------------------------------------------------------------

    /**
     * @description Stores metadata for files uploaded for maintenance records. Writable
     *              only by admins, but readable by any authenticated user.
     * @path        /files/{fileId}
     * @allow       An admin (auth.uid exists in /roles_admin) creating a file metadata document.
     * @deny        A non-admin user (create) attempting to create a file record.
     * @principle   Enforces admin-only control over file metadata.
     */
    match /files/{fileId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isAdmin();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }
  }
}
